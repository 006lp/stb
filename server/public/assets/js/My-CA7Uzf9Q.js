import{r as a,o as e,f as l,g as u,i,m as t,aq as n,h as s,k as o,$ as r,ar as v,q as d,x as c,y as m,z as p,l as g,as as _,E as f,e as y,j as k,ai as h,aj as b,ak as C,a0 as I,at as w,a1 as x,au as U,J as $,a3 as j,n as z,av as q,a6 as O,aw as F,D as K,ax as V,p as D,C as M,_ as E,ad as J}from"./vendor-Ct0GE2cv.js";import{f as R,a as S,c as A}from"./formatDate-_UAqMSvc.js";import{_ as B,u as G,i as H}from"./index-D-heiWuO.js";import{_ as L}from"./ImageInfoModal-DLh9CTU0.js";const N={class:"my-images"},P={class:"card-title"},Q={class:"album-list-overview"},T={key:1,class:"none-cover"},W={key:0},X={key:1,class:"image-grid"},Y={class:"image-info"},Z={class:"image-tags"},aa={class:"pagination"},ea={key:1,style:{"margin-top":"10px"}},la={key:1,class:"image-select-grid"},ua=["onClick"],ia=["src","alt"],ta={style:{"text-align":"center","margin-top":"5px","font-size":"12px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},na={class:"pagination",style:{"margin-top":"20px"}},sa=B({__name:"My",setup(B){const sa=G(),oa=a(!1),ra=a(!1),va=a([]),da=a(0),ca=a(1),ma=a(12),pa=a(!1),ga=a({}),_a=a(0),fa=a([]),ya=a(0),ka=a(null),ha=a(!1),ba=a(!1),Ca=a(null),Ia=a({_id:null,name:"",permission:"public",coverImage:null}),wa={name:[{required:!0,message:"请输入相册名称",trigger:"blur"}],permission:[{required:!0,message:"请选择权限",trigger:"change"}]},xa=a(!1),Ua=a(null),$a=a(!1),ja=a(!1),za=a([]),qa=a(0),Oa=a(1),Fa=a(20),Ka=async()=>{var a;oa.value=!0;try{const a={page:ca.value,limit:ma.value};void 0!==ka.value&&null!==ka.value?a.albumId=ka.value._id:a.albumId="standalone";const{data:e}=await H.post("/api/auth/my",j.stringify(a));va.value=e.images,da.value=e.total}catch({response:e}){$.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{oa.value=!1}},Va=async()=>{var a;ra.value=!0;try{const{data:a}=await H.post("/api/auth/albums/my");fa.value=a.albums||[],ya.value=a.standaloneCount||0}catch({response:e}){$.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{ra.value=!1}},Da=async()=>{var a;ja.value=!0;try{const{data:a}=await H.post("/api/auth/my",j.stringify({page:Oa.value,limit:Fa.value}));za.value=a.images,qa.value=a.total}catch({response:e}){$.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}finally{ja.value=!1}},Ma=a=>{ca.value=a,Ka()},Ea=a=>{ka.value=a,ca.value=1,da.value=0,va.value=[],Ka()},Ja=()=>{ba.value=!1,Ia.value={_id:null,name:"",permission:"public",tags:[],coverImage:null},ha.value=!0,Ca.value&&Ca.value.resetFields()},Ra=async()=>{var a;try{await Ca.value.validate();const a={name:Ia.value.name,permission:Ia.value.permission,coverImage:Ia.value.coverImage?Ia.value.coverImage._id:null};if(ba.value?(await H.patch(`/api/auth/albums/${Ia.value._id}`,a),$.success("相册更新成功")):(await H.post("/api/auth/albums",a),$.success("相册创建成功")),ha.value=!1,Va(),ba.value&&ka.value&&ka.value._id===Ia.value._id){-1!==fa.value.findIndex((a=>a._id===Ia.value._id))&&Va()}}catch({response:e}){$.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}},Sa=async(a,e)=>{var l;try{await H.patch(`/api/auth/images/${a}/album`,{albumId:e}),$.success(e?"图片已添加到相册":"图片已移出相册"),Ka(),Va()}catch({response:u}){$.error(null==(l=null==u?void 0:u.data)?void 0:l.error)}},Aa=async()=>{var a;if(Ua.value)try{const a=Ua.value._id;await H.patch(`/api/auth/images/${a}/tags`,{tags:Ua.value.tags}),$.success("图片标签更新成功"),xa.value=!1,Ka()}catch({response:e}){$.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}},Ba=()=>{Oa.value=1,za.value=[],qa.value=0,Da(),$a.value=!0},Ga=()=>{Ia.value.coverImage=null};return e((()=>{Va(),Ea(null)})),(a,e)=>{const j=f,B=y("router-link"),G=v,Ha=r,La=x,Na=q,Pa=O,Qa=E,Ta=M,Wa=D,Xa=K,Ya=_,Za=n,ae=C,ee=b,le=w,ue=I,ie=h,te=U;return u(),l("div",N,[i(Ha,null,{title:t((()=>[s("div",P,[e[17]||(e[17]=s("span",null,"我的图片",-1)),s("div",null,[i(j,{style:{"margin-right":"10px"},onClick:Ja},{default:t((()=>e[15]||(e[15]=[d("创建相册")]))),_:1,__:[15]}),i(j,{type:"primary"},{default:t((()=>[i(B,{to:"/"},{default:t((()=>[i(k(J)),e[16]||(e[16]=d(" 上传图片 "))])),_:1,__:[16]})])),_:1})])])])),default:t((()=>[i(Za,{spinning:oa.value||ra.value},{default:t((()=>[s("div",Q,[i(Ha,{hoverable:"",onClick:e[0]||(e[0]=a=>Ea(null))},{default:t((()=>[i(G,{title:"独立图片"},{description:t((()=>[d("共 "+c(ya.value)+" 张",1)])),_:1})])),_:1}),(u(!0),l(m,null,p(fa.value,(a=>(u(),o(Ha,{hoverable:"",key:a._id,onClick:e=>Ea(a)},{cover:t((()=>[a.coverImage?(u(),o(La,{key:0,src:k(sa).config.site.url+a.coverImage.thumb,preview:!1},null,8,["src"])):(u(),l("div",T,"无封面"))])),actions:t((()=>[i(j,{type:"link",onClick:z((e=>(a=>{ba.value=!0,Ia.value={_id:a._id,name:a.name,permission:a.permission,tags:a.tags||[],coverImage:a.coverImage||null},ha.value=!0,Ca.value&&Ca.value.resetFields()})(a)),["stop"])},{default:t((()=>e[18]||(e[18]=[d("编辑")]))),_:2,__:[18]},1032,["onClick"]),i(j,{type:"link",danger:"",onClick:z((e=>(a=>{U.confirm({title:"确认删除相册",content:`确定要删除相册 "${a.name}" 吗？相册内的图片将被移出相册，但不会被删除。`,async onOk(){var e;try{await H.delete(`/api/auth/albums/${a._id}`),$.success("相册已删除，图片已移出"),Va(),ka.value&&ka.value._id===a._id&&Ea(null)}catch({response:l}){$.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}}})})(a)),["stop"])},{default:t((()=>e[19]||(e[19]=[d("删除")]))),_:2,__:[19]},1032,["onClick"])])),default:t((()=>[i(G,{title:a.name},{description:t((()=>[d("权限: "+c("public"===a.permission?"公开":"私有"),1)])),_:2},1032,["title"])])),_:2},1032,["onClick"])))),128))]),s("h2",null,[d(c(ka.value?ka.value.name:"独立图片")+" ",1),ka.value?(u(),l("small",W,"("+c("public"===ka.value.permission?"公开":"私有")+")",1)):g("",!0)]),0!==va.value.length||oa.value?(u(),l("div",X,[(u(!0),l(m,null,p(va.value,(a=>(u(),l("div",{key:a._id,class:"image-item"},[i(Ha,{hoverable:""},{cover:t((()=>[i(La,{src:k(sa).config.site.url+a.thumb,preview:{visible:!1},onClick:e=>(a=>{ga.value=a,pa.value=!0})(a)},null,8,["src","onClick"])])),actions:t((()=>[i(j,{type:"link",onClick:e=>k(A)(e,a,k(sa))},{default:t((()=>[i(k(F)),e[20]||(e[20]=d(" 复制 "))])),_:2,__:[20]},1032,["onClick"]),i(Xa,null,{overlay:t((()=>[i(Wa,null,{default:t((()=>[i(Ta,{key:"album",title:"修改相册"},{default:t((()=>[i(Qa,{disabled:!a.album,onClick:e=>Sa(a._id,null)},{default:t((()=>e[22]||(e[22]=[d(" 独立图片 ")]))),_:2,__:[22]},1032,["disabled","onClick"]),(u(!0),l(m,null,p(fa.value,(e=>(u(),o(Qa,{key:e._id,disabled:a.album===e._id,onClick:l=>Sa(a._id,e._id)},{default:t((()=>[d(c(e.name),1)])),_:2},1032,["disabled","onClick"])))),128))])),_:2},1024),i(Qa,{onClick:e=>(a=>{Ua.value=a,xa.value=!0})(a)},{default:t((()=>[d(c(a.tags.length?"修改标签":"添加标签"),1)])),_:2},1032,["onClick"]),i(Qa,{onClick:e=>(async a=>{U.confirm({title:"确认删除",content:`确定要删除图片 "${a.filename}" 吗？`,async onOk(){var e;try{await H.delete(`/api/auth/images/${a._id}`),$.success("删除成功"),Ka(),ka.value||Va()}catch({response:l}){$.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}}})})(a)},{default:t((()=>e[23]||(e[23]=[d("删除图片")]))),_:2,__:[23]},1032,["onClick"])])),_:2},1024)])),default:t((()=>[s("a",{class:"ant-dropdown-link",onClick:e[1]||(e[1]=z((()=>{}),["prevent"]))},[i(k(V)),e[21]||(e[21]=d(" 更多 "))])])),_:2},1024)])),default:t((()=>[i(G,null,{title:t((()=>[d(c(a.filename),1)])),description:t((()=>[s("div",Y,[s("span",null,c(k(R)(a.size)),1),s("span",null,c(k(S)(a.date)),1)]),s("div",Z,[(u(!0),l(m,null,p(a.tags,(a=>(u(),o(Pa,{key:a},{default:t((()=>[d(c(a),1)])),_:2},1024)))),128))])])),_:2},1024)])),_:2},1024)])))),128))])):(u(),o(Na,{key:0,description:"暂无图片"})),s("div",aa,[i(Ya,{current:ca.value,"onUpdate:current":e[2]||(e[2]=a=>ca.value=a),total:da.value,"page-size":ma.value,onChange:Ma},null,8,["current","total","page-size"])])])),_:1},8,["spinning"])])),_:1}),i(L,{modelValue:pa.value,"onUpdate:modelValue":e[3]||(e[3]=a=>pa.value=a),imageInfo:ga.value,"onUpdate:imageInfo":e[4]||(e[4]=a=>ga.value=a),imageKey:_a.value,"onUpdate:imageKey":e[5]||(e[5]=a=>_a.value=a),images:va.value},null,8,["modelValue","imageInfo","imageKey","images"]),i(te,{open:ha.value,"onUpdate:open":e[8]||(e[8]=a=>ha.value=a),title:ba.value?"编辑相册":"创建相册",onOk:Ra,onCancel:e[9]||(e[9]=a=>ha.value=!1)},{default:t((()=>[i(ie,{model:Ia.value,rules:wa,ref_key:"albumFormRef",ref:Ca,layout:"vertical"},{default:t((()=>[i(ee,{label:"相册名称",name:"name"},{default:t((()=>[i(ae,{value:Ia.value.name,"onUpdate:value":e[6]||(e[6]=a=>Ia.value.name=a),placeholder:"请输入相册名称"},null,8,["value"])])),_:1}),i(ee,{label:"权限",name:"permission"},{default:t((()=>[i(ue,{value:Ia.value.permission,"onUpdate:value":e[7]||(e[7]=a=>Ia.value.permission=a),placeholder:"请选择相册权限"},{default:t((()=>[i(le,{value:"public"},{default:t((()=>e[24]||(e[24]=[d("公开")]))),_:1,__:[24]}),i(le,{value:"private"},{default:t((()=>e[25]||(e[25]=[d("私有")]))),_:1,__:[25]})])),_:1},8,["value"])])),_:1}),ba.value?(u(),o(ee,{key:0,label:"封面图片"},{default:t((()=>[i(j,{type:"primary",style:{"margin-right":"10px"},onClick:Ba},{default:t((()=>e[26]||(e[26]=[d("选择图片")]))),_:1,__:[26]}),Ia.value.coverImage?(u(),o(j,{key:0,type:"primary",danger:"",onClick:Ga},{default:t((()=>e[27]||(e[27]=[d("移除封面")]))),_:1,__:[27]})):g("",!0),Ia.value.coverImage?(u(),l("div",ea,[i(La,{src:k(sa).config.site.url+Ia.value.coverImage.thumb,height:200},null,8,["src"])])):g("",!0)])),_:1})):g("",!0)])),_:1},8,["model"])])),_:1},8,["open","title"]),i(te,{open:xa.value,"onUpdate:open":e[11]||(e[11]=a=>xa.value=a),title:"标签",onOk:Aa,onCancel:e[12]||(e[12]=a=>xa.value=!1)},{default:t((()=>[i(ue,{value:Ua.value.tags,"onUpdate:value":e[10]||(e[10]=a=>Ua.value.tags=a),mode:"tags",placeholder:"输入标签，按回车键添加",style:{width:"100%"}},null,8,["value"])])),_:1},8,["open"]),i(te,{open:$a.value,"onUpdate:open":e[14]||(e[14]=a=>$a.value=a),title:"选择相册封面",width:"80%",footer:null},{default:t((()=>[i(Za,{spinning:ja.value},{default:t((()=>[0!==za.value.length||ja.value?(u(),l("div",la,[(u(!0),l(m,null,p(za.value,(a=>(u(),l("div",{key:a._id,class:"image-select-item",onClick:e=>(a=>{Ia.value.coverImage=a,$a.value=!1})(a)},[i(Ha,{hoverable:"",bodyStyle:{padding:"5px"}},{default:t((()=>[s("img",{src:k(sa).config.site.url+a.thumb,alt:a.filename,style:{width:"100%",height:"120px","object-fit":"cover"}},null,8,ia),s("p",ta,c(a.filename),1)])),_:2},1024)],8,ua)))),128))])):(u(),o(Na,{key:0,description:"暂无图片可选"})),s("div",na,[i(Ya,{current:Oa.value,"onUpdate:current":e[13]||(e[13]=a=>Oa.value=a),total:qa.value,"page-size":Fa.value,onChange:Da},null,8,["current","total","page-size"])])])),_:1},8,["spinning"])])),_:1},8,["open"])])}}},[["__scopeId","data-v-5a7ba412"]]);export{sa as default};
