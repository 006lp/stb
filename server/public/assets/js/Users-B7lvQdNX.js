import{r as e,o as a,e as l,g as r,h as u,k as s,a4 as t,I as o,aL as d,a2 as n,au as i,aw as v,ay as p,f as m,p as c,aM as g,aN as f,v as _,a7 as b,j as w,am as y,an as h,ao as k,ap as U,a0 as C,F as q,x,m as F,ax as j}from"./vendor-yaG8ImNT.js";import{_ as z,i as I}from"./index-k-75TJoX.js";import{a as L}from"./formatDate-Cfm9J1s9.js";const O={class:"users"},$={class:"header"},A=z({__name:"Users",setup(z){const A=e([]),R=e(!1),S=e(1),D=e(10),M=e(0),N=e(""),P=e([]),B=e(!1),E=e(null),G=e({username:"",email:"",password:"",role:""}),H=e(!1),J=e(null),K=e({_id:"",username:"",email:"",role:"",status:"",founder:!1,password:""}),Q={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}]},T={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],password:[{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}]},V=async()=>{var e;R.value=!0,A.value=[];try{(async()=>{var e;R.value=!0;try{const{data:e}=await I.post("/api/admin/role-groups");P.value=e}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}finally{R.value=!1}})();const{data:e}=await I.post("/api/admin/users",t.stringify({page:S.value,limit:D.value,username:N.value}));M.value=e.total,A.value.push(...e.users)}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}finally{R.value=!1}},W=()=>{G.value={username:"",email:"",password:"",role:""},B.value=!0,E.value&&E.value.resetFields()},X=async()=>{var e;try{await E.value.validate(),await I.post("/api/admin/users/create",G.value),o.success("用户创建成功"),B.value=!1,V()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}},Y=async()=>{var e;try{await J.value.validate();const e=K.value._id,a={username:K.value.username,email:K.value.email,role:K.value.role,status:K.value.status};K.value.password&&(a.password=K.value.password),K.value.founder&&(delete a.role,delete a.status),await I.patch(`/api/admin/users/${e}`,a),o.success("用户数据更新成功"),H.value=!1,V()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}};return a(V),(e,a)=>{const t=d,z=n,Z=f,ee=b,ae=g,le=i,re=v,ue=k,se=h,te=U,oe=j,de=C,ne=y,ie=p;return m(),l("div",O,[r("div",$,[u(t,{value:N.value,"onUpdate:value":a[0]||(a[0]=e=>N.value=e),allowClear:"",placeholder:"输入用户名搜索",onSearch:V},null,8,["value"]),u(z,{type:"primary",onClick:W},{default:s((()=>a[16]||(a[16]=[c("创建用户")]))),_:1,__:[16]})]),u(le,{spinning:R.value},{default:s((()=>[u(ae,{data:A.value,"scrollbar-always-on":"",fit:""},{default:s((()=>[u(Z,{prop:"username",label:"用户名",fixed:""}),u(Z,{prop:"name",label:"IP地址"},{default:s((({row:e})=>{var a,l;return[c(_((null==(a=e.ip)?void 0:a.ipv4)||(null==(l=e.ip)?void 0:l.ipv6)),1)]})),_:1}),u(Z,{prop:"email",label:"注册邮箱"}),u(Z,{prop:"role",label:"角色组"},{default:s((({row:e})=>[c(_(P.value.find((a=>a._id===e.role)).name),1)])),_:1}),u(Z,{prop:"date",label:"状态"},{default:s((({row:e})=>[u(ee,{color:"active"===e.status?"green":"red"},{default:s((()=>[c(_("active"===e.status?"正常":"封号"),1)])),_:2},1032,["color"])])),_:1}),u(Z,{prop:"createdAt",sortable:"",label:"注册时间"},{default:s((({row:e})=>[c(_(w(L)(e.createdAt)),1)])),_:1}),u(Z,{prop:"lastLogin",sortable:"",label:"最后登录"},{default:s((({row:e})=>[c(_(w(L)(e.lastLogin)),1)])),_:1}),u(Z,{label:"操作",fixed:"right"},{default:s((({row:e})=>[u(z,{type:"link",onClick:a=>{return l=e,K.value={_id:l._id,username:l.username,email:l.email,role:l.role,status:l.status,founder:l.founder,password:""},H.value=!0,void(J.value&&J.value.resetFields());var l}},{default:s((()=>a[17]||(a[17]=[c("编辑")]))),_:2,__:[17]},1032,["onClick"]),u(z,{type:"link",danger:"",onClick:a=>(async e=>{e.founder?o.error("无法删除创始人账号"):p.confirm({title:"确认删除",content:`确定要删除用户 "${e.username}" 的账号吗？`,async onOk(){var a;try{await I.delete(`/api/admin/users/${e._id}`),o.success("该账号已删除"),V()}catch({response:l}){o.error(null==(a=null==l?void 0:l.data)?void 0:a.error)}}})})(e),disabled:e.founder},{default:s((()=>a[18]||(a[18]=[c("删除")]))),_:2,__:[18]},1032,["onClick","disabled"])])),_:1})])),_:1},8,["data"])])),_:1},8,["spinning"]),u(re,{class:"pagination",current:S.value,"onUpdate:current":a[1]||(a[1]=e=>S.value=e),"page-size":D.value,"onUpdate:pageSize":a[2]||(a[2]=e=>D.value=e),total:M.value,"show-size-changer":"",onChange:V},null,8,["current","page-size","total"]),u(ie,{open:B.value,"onUpdate:open":a[7]||(a[7]=e=>B.value=e),title:"创建用户",onOk:X,onCancel:a[8]||(a[8]=e=>B.value=!1)},{default:s((()=>[u(ne,{model:G.value,rules:Q,layout:"vertical",ref_key:"createFormRef",ref:E},{default:s((()=>[u(se,{label:"用户名",name:"username"},{default:s((()=>[u(ue,{value:G.value.username,"onUpdate:value":a[3]||(a[3]=e=>G.value.username=e),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(se,{label:"邮箱",name:"email"},{default:s((()=>[u(ue,{value:G.value.email,"onUpdate:value":a[4]||(a[4]=e=>G.value.email=e),placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(se,{label:"密码",name:"password"},{default:s((()=>[u(te,{value:G.value.password,"onUpdate:value":a[5]||(a[5]=e=>G.value.password=e),placeholder:"请输入密码"},null,8,["value"])])),_:1}),u(se,{label:"权限",name:"role"},{default:s((()=>[u(de,{value:G.value.role,"onUpdate:value":a[6]||(a[6]=e=>G.value.role=e)},{default:s((()=>[(m(!0),l(q,null,x(P.value,(e=>(m(),F(oe,{value:e._id,key:e._id},{default:s((()=>[c(_(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"]),u(ie,{open:H.value,"onUpdate:open":a[14]||(a[14]=e=>H.value=e),title:"编辑用户",onOk:Y,onCancel:a[15]||(a[15]=e=>H.value=!1)},{default:s((()=>[u(ne,{model:K.value,rules:T,layout:"vertical",ref_key:"editFormRef",ref:J},{default:s((()=>[u(se,{label:"用户名",name:"username"},{default:s((()=>[u(ue,{value:K.value.username,"onUpdate:value":a[9]||(a[9]=e=>K.value.username=e),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(se,{label:"邮箱",name:"email"},{default:s((()=>[u(ue,{value:K.value.email,"onUpdate:value":a[10]||(a[10]=e=>K.value.email=e),placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(se,{label:"权限",name:"role"},{default:s((()=>[u(de,{value:K.value.role,"onUpdate:value":a[11]||(a[11]=e=>K.value.role=e),disabled:K.value.founder},{default:s((()=>[(m(!0),l(q,null,x(P.value,(e=>(m(),F(oe,{value:e._id,key:e._id},{default:s((()=>[c(_(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value","disabled"])])),_:1}),u(se,{label:"状态",name:"status"},{default:s((()=>[u(de,{value:K.value.status,"onUpdate:value":a[12]||(a[12]=e=>K.value.status=e),disabled:K.value.founder},{default:s((()=>[u(oe,{value:"active"},{default:s((()=>a[19]||(a[19]=[c("正常")]))),_:1,__:[19]}),u(oe,{value:"disabled"},{default:s((()=>a[20]||(a[20]=[c("封号")]))),_:1,__:[20]})])),_:1},8,["value","disabled"])])),_:1}),u(se,{label:"新密码",name:"password"},{default:s((()=>[u(te,{value:K.value.password,"onUpdate:value":a[13]||(a[13]=e=>K.value.password=e),placeholder:"留空则不修改密码"},null,8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"])])}}},[["__scopeId","data-v-0818197b"]]);export{A as default};
