import{r as a,o as e,f as l,h as t,i as r,m as s,y as i,a3 as o,J as u,ai as n,aq as d,as as v,$ as p,aS as c,g as f,aj as m,aT as y,j as g,aU as _,ak as h,E as b,q as x,aI as Y,aJ as w,x as k,au as D}from"./vendor-Ct0GE2cv.js";import{_ as S,i as C}from"./index-D-heiWuO.js";import{a as M,f as $}from"./formatDate-_UAqMSvc.js";const I={class:"logs-container"},A={class:"search-bar"},U={class:"stats-card"},j=S({__name:"Logs",setup(S){const j=a(!1),z=a([]),L=a([]),O=a(1),P=a(10),T=a(0),R=a(""),q=a(""),J=a(null),N=a(null),B=a(null),E=a(null),X=a(null),F=a(null),G=async()=>{var a,e,l;j.value=!0;try{const{data:l}=await C.post("/api/admin/logs",o.stringify({page:O.value,limit:P.value,startDate:null==(a=L.value[0])?void 0:a.format("YYYY-MM-DD"),endDate:null==(e=L.value[1])?void 0:e.format("YYYY-MM-DD"),ip:q.value,username:R.value}));z.value=l.logs,T.value=l.total}catch({response:t}){u.error(null==(l=null==t?void 0:t.data)?void 0:l.error)}finally{j.value=!1}},H=async()=>{var a,e,l;try{const{data:l}=await C.post("/api/admin/logs/stats",o.stringify({startDate:null==(a=L.value[0])?void 0:a.format("YYYY-MM-DD"),endDate:null==(e=L.value[1])?void 0:e.format("YYYY-MM-DD")}));K(l)}catch({response:t}){u.error(null==(l=null==t?void 0:t.data)?void 0:l.error)}},K=a=>{E.value&&E.value.dispose(),X.value&&X.value.dispose(),F.value&&F.value.dispose(),E.value=c(J.value),X.value=c(N.value),F.value=c(B.value),E.value.setOption({tooltip:{trigger:"item",formatter:a=>`${a.seriesName}: ${a.value}`},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:a.dailyStats.map((a=>`${a._id.year}-${a._id.month}-${a._id.day}`)),axisLabel:{rotate:45}},yAxis:{type:"value",name:"上传数量"},series:[{data:a.dailyStats.map((a=>a.count)),type:"line",smooth:!0,name:"上传数量",itemStyle:{color:"#1890ff"}}]}),X.value.setOption({tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},series:[{type:"pie",radius:"50%",data:a.ipStats.map((a=>({name:a._id||"未知IP",value:a.count}))),emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}),F.value.setOption({tooltip:{trigger:"item",formatter:function(a){return`上传数量: ${a.value}`}},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:a.userStats.map((a=>a.username||"未知用户")),axisLabel:{rotate:45}},yAxis:{type:"value",name:"上传数量"},series:[{data:a.userStats.map((a=>a.count)),type:"bar",name:"上传数量",itemStyle:{color:"#1890ff"},emphasis:{itemStyle:{color:"#40a9ff"}}}]})};e((()=>{G(),H()}));const Q=()=>{O.value=1,G(),L.value.length&&H()},V=()=>{L.value.length&&Q(),L.value=[],R.value="",q.value=""},W=async()=>{var a;try{D.confirm({title:"确认清空",content:"确定要清空所有日志吗？此操作不可恢复！",okText:"确定",okType:"danger",cancelText:"取消",onOk:async()=>{await C.delete("/api/admin/logs"),u.success("所有日志已清空"),G()}})}catch({response:e}){u.error(null==(a=null==e?void 0:e.data)?void 0:a.error)}};return(a,e)=>{const o=y,c=m,D=h,S=b,E=n,X=w,F=Y,H=d,K=v,Z=p;return f(),l(i,null,[t("div",I,[t("div",A,[r(E,{layout:"inline"},{default:s((()=>[r(c,{label:"日期范围",class:"range-picker"},{default:s((()=>[r(o,{value:L.value,"onUpdate:value":e[0]||(e[0]=a=>L.value=a),locale:g(_)},null,8,["value","locale"])])),_:1}),r(c,{label:"用户名"},{default:s((()=>[r(D,{value:R.value,"onUpdate:value":e[1]||(e[1]=a=>R.value=a),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),r(c,{label:"IP地址"},{default:s((()=>[r(D,{value:q.value,"onUpdate:value":e[2]||(e[2]=a=>q.value=a),placeholder:"请输入IP地址"},null,8,["value"])])),_:1}),r(c,{class:"search-button"},{default:s((()=>[r(S,{type:"primary",disabled:!L.value.length&&!R.value&&!q.value,onClick:Q},{default:s((()=>e[5]||(e[5]=[x(" 搜索 ")]))),_:1,__:[5]},8,["disabled"]),r(S,{style:{"margin-left":"8px"},disabled:!L.value.length,onClick:V},{default:s((()=>e[6]||(e[6]=[x("重置")]))),_:1,__:[6]},8,["disabled"]),r(S,{type:"primary",danger:"",style:{"margin-left":"8px"},onClick:W},{default:s((()=>e[7]||(e[7]=[x("清空日志")]))),_:1,__:[7]})])),_:1})])),_:1})]),r(H,{spinning:j.value},{default:s((()=>[r(F,{data:z.value,"scrollbar-always-on":!0,fit:""},{default:s((()=>[r(X,{label:"用户名",fixed:""},{default:s((({row:a})=>{var e;return[x(k((null==(e=null==a?void 0:a.user)?void 0:e.username)||"游客"),1)]})),_:1}),r(X,{prop:"ip",label:"IP地址"}),r(X,{prop:"createdAt",label:"上传时间"},{default:s((({row:a})=>[x(k(g(M)(a.createdAt)),1)])),_:1}),r(X,{prop:"originalName",label:"文件名"}),r(X,{label:"文件大小"},{default:s((({row:a})=>[x(k(g($)(a.size)),1)])),_:1}),r(X,{label:"图片尺寸"},{default:s((({row:a})=>[x(k(a.width)+"x"+k(a.height),1)])),_:1}),r(X,{prop:"format",label:"图片格式"}),r(X,{label:"操作",fixed:"right"},{default:s((({row:a})=>[r(S,{type:"link",danger:"",onClick:e=>(async a=>{var e;try{await C.delete(`/api/admin/logs/${a}`),u.success("删除成功"),G()}catch({response:l}){u.error(null==(e=null==l?void 0:l.data)?void 0:e.error)}})(a._id)},{default:s((()=>e[8]||(e[8]=[x("删除")]))),_:2,__:[8]},1032,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1},8,["spinning"]),r(K,{current:O.value,"onUpdate:current":e[3]||(e[3]=a=>O.value=a),"page-size":P.value,"onUpdate:pageSize":e[4]||(e[4]=a=>P.value=a),total:T.value,"show-size-changer":"",onChange:G},null,8,["current","page-size","total"])]),t("div",U,[r(Z,{title:"每日上传统计"},{default:s((()=>[t("div",{ref_key:"dailyChartRef",ref:J,style:{height:"300px"}},null,512)])),_:1}),r(Z,{title:"IP分布统计"},{default:s((()=>[t("div",{ref_key:"ipChartRef",ref:N,style:{height:"300px"}},null,512)])),_:1}),r(Z,{title:"用户上传统计"},{default:s((()=>[t("div",{ref_key:"userChartRef",ref:B,style:{height:"300px"}},null,512)])),_:1})])],64)}}},[["__scopeId","data-v-a53ca818"]]);export{j as default};
