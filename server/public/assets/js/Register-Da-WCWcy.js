import{r as e,c as a,ah as r,o as l,J as s,f as i,g as t,i as d,m as o,ai as u,k as n,l as c,aj as p,ak as v,j as m,aA as g,E as f,q as h,x as _,al as w,e as b,$ as y,b as C,a3 as x,U as I,aB as k,aC as q,an as U}from"./vendor-Ct0GE2cv.js";import{_ as P,u as j,i as R}from"./index-D-heiWuO.js";import{C as E}from"./Captcha-D6sqaGmE.js";const S={class:"register"},$=P({__name:"Register",setup(P){const $=C(),A=j(),B=e(!1),F=e(0),J=a((()=>{var e,a;return null==(a=null==(e=null==A?void 0:A.config)?void 0:e.site)?void 0:a.captcha})),L=r({username:"",email:"",code:"",password:"",confirmPassword:"",inviteCode:"",captcha:!1,captchaId:""}),z=a((()=>{var e,a,r,l;let s=!(L.username&&L.email&&L.password&&L.confirmPassword);return(null==(a=null==(e=null==A?void 0:A.config)?void 0:e.smtp)?void 0:a.enabled)&&(s=s||!L.code),(null==(l=null==(r=null==A?void 0:A.config)?void 0:r.site)?void 0:l.inviteCodeRequired)&&(s=s||!L.inviteCode),J.value&&(s=s||!L.captcha||!L.captchaId),s})),D={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}],code:[{required:!0,message:"请输入验证码",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:async(e,a)=>{if(a!==L.password)throw new Error("两次输入的密码不一致")},trigger:"blur"}],inviteCode:[{required:!0,message:"请输入邀请码",trigger:"blur"}]},G=async()=>{if(L.email)try{await R.post("/api/auth/register/send-code",x.stringify({email:L.email,username:L.username})),s.success("验证码已发送到您的邮箱"),F.value=60;const e=setInterval((()=>{F.value--,F.value<=0&&clearInterval(e)}),1e3)}catch({response:e}){s.error(e.data.error||"发送验证码失败")}else s.error("请先输入邮箱")},H=async()=>{var e;try{B.value=!0;const{data:e}=await R.post("/api/auth/register",{username:L.username,password:L.password,email:L.email,code:L.code,ip:A.ip,inviteCode:L.inviteCode,captchaId:L.captchaId});A.token=e.token,A.user=e.user,s.success("注册成功"),$.push("/")}catch({response:a}){s.error((null==(e=null==a?void 0:a.data)?void 0:e.error)||"注册失败")}finally{B.value=!1}};return l((()=>{new URLSearchParams(location.search).get("oauth")&&(history.replaceState({},document.title,location.pathname),s.error("请注册后再使用本功能"))})),(e,a)=>{const r=v,l=p,s=f,C=g,x=w,P=b("router-link"),j=u,R=y;return t(),i("div",S,[d(R,{class:"register-card",title:"注册"},{default:o((()=>[d(j,{model:L,onFinish:H},{default:o((()=>{var e,i,u,p,v,g;return[d(l,{name:"username",rules:D.username},{default:o((()=>[d(r,{value:L.username,"onUpdate:value":a[0]||(a[0]=e=>L.username=e),placeholder:"请输入用户名"},{prefix:o((()=>[d(m(I))])),_:1},8,["value"])])),_:1},8,["rules"]),d(l,{name:"email",rules:D.email},{default:o((()=>[d(r,{value:L.email,"onUpdate:value":a[1]||(a[1]=e=>L.email=e),placeholder:"请输入邮箱"},{prefix:o((()=>[d(m(k))])),_:1},8,["value"])])),_:1},8,["rules"]),(null==(u=null==(i=null==(e=m(A))?void 0:e.config)?void 0:i.smtp)?void 0:u.enabled)?(t(),n(l,{key:0,name:"code",rules:D.code},{default:o((()=>[d(C,{compact:""},{default:o((()=>[d(r,{value:L.code,"onUpdate:value":a[2]||(a[2]=e=>L.code=e),placeholder:"请输入验证码",style:{width:"calc(100% - 120px)"}},{prefix:o((()=>[d(m(q))])),_:1},8,["value"]),d(s,{disabled:!L.email||!!F.value,style:{width:"120px"},onClick:G},{default:o((()=>[h(_(F.value?`${F.value}s后重试`:"获取验证码"),1)])),_:1},8,["disabled"])])),_:1})])),_:1},8,["rules"])):c("",!0),d(l,{name:"password",rules:D.password},{default:o((()=>[d(x,{value:L.password,"onUpdate:value":a[3]||(a[3]=e=>L.password=e),placeholder:"请输入密码"},{prefix:o((()=>[d(m(U))])),_:1},8,["value"])])),_:1},8,["rules"]),d(l,{name:"confirmPassword",rules:D.confirmPassword},{default:o((()=>[d(x,{value:L.confirmPassword,"onUpdate:value":a[4]||(a[4]=e=>L.confirmPassword=e),placeholder:"请确认密码"},{prefix:o((()=>[d(m(U))])),_:1},8,["value"])])),_:1},8,["rules"]),(null==(g=null==(v=null==(p=m(A))?void 0:p.config)?void 0:v.site)?void 0:g.inviteCodeRequired)?(t(),n(l,{key:1,name:"inviteCode",rules:D.inviteCode},{default:o((()=>[d(r,{value:L.inviteCode,"onUpdate:value":a[5]||(a[5]=e=>L.inviteCode=e),placeholder:"请输入邀请码"},{prefix:o((()=>[d(m(U))])),_:1},8,["value"])])),_:1},8,["rules"])):c("",!0),J.value?(t(),n(l,{key:2,required:"",name:"captcha"},{default:o((()=>[d(E,{value:L.captcha,"onUpdate:value":a[6]||(a[6]=e=>L.captcha=e),captchaId:L.captchaId,"onUpdate:captchaId":a[7]||(a[7]=e=>L.captchaId=e)},null,8,["value","captchaId"])])),_:1})):c("",!0),d(l,null,{default:o((()=>[d(s,{type:"primary","html-type":"submit",loading:B.value,disabled:z.value,block:""},{default:o((()=>a[8]||(a[8]=[h(" 注册 ")]))),_:1,__:[8]},8,["loading","disabled"])])),_:1}),d(l,null,{default:o((()=>[d(P,{to:"/login"},{default:o((()=>a[9]||(a[9]=[h("已有账号？去登录")]))),_:1,__:[9]}),a[11]||(a[11]=h(" 或者 ")),d(P,{to:"/reset-password"},{default:o((()=>a[10]||(a[10]=[h("找回密码")]))),_:1,__:[10]})])),_:1,__:[11]})]})),_:1},8,["model"])])),_:1})])}}},[["__scopeId","data-v-5e88b9b8"]]);export{$ as default};
