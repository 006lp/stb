import{r as e,o as a,f as l,h as r,i as u,m as s,a3 as t,J as o,aH as d,E as n,aq as i,as as v,au as m,g as p,q as c,aI as _,aJ as f,x as g,a6 as b,j as w,ai as h,aj as y,ak as U,al as k,a0 as q,at as C}from"./vendor-Ct0GE2cv.js";import{_ as x,i as j}from"./index-D-heiWuO.js";import{a as z}from"./formatDate-_UAqMSvc.js";const F={class:"users"},I={class:"header"},O=x({__name:"Users",setup(x){const O=e([]),$=e(!1),A=e(1),J=e(10),L=e(0),R=e(""),S=e(!1),D=e(null),E=e({username:"",email:"",password:"",role:"user"}),H=e(!1),P=e(null),B=e({_id:"",username:"",email:"",role:"",status:"",founder:!1,password:""}),G={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}]},K={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度应在3-20个字符之间",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],role:[{required:!0,message:"请选择角色",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],password:[{min:6,message:"密码长度不能小于6个字符",trigger:"blur"}]},M=async()=>{var e;$.value=!0,O.value=[];try{const{data:e}=await j.post("/api/admin/users",t.stringify({page:A.value,limit:J.value,username:R.value}));L.value=e.total,O.value.push(...e.users)}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}finally{$.value=!1}},N=()=>{E.value={username:"",email:"",password:"",role:"user"},S.value=!0,D.value&&D.value.resetFields()},Q=async()=>{var e;try{await D.value.validate(),await j.post("/api/admin/users/create",E.value),o.success("用户创建成功"),S.value=!1,M()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}},T=async()=>{var e;try{await P.value.validate();const e=B.value._id,a={username:B.value.username,email:B.value.email,role:B.value.role,status:B.value.status};B.value.password&&(a.password=B.value.password),B.value.founder&&(delete a.role,delete a.status),await j.patch(`/api/admin/users/${e}`,a),o.success("用户数据更新成功"),H.value=!1,M()}catch({response:a}){o.error(null==(e=null==a?void 0:a.data)?void 0:e.error)}};return a(M),(e,a)=>{const t=d,x=n,V=f,W=b,X=_,Y=i,Z=v,ee=U,ae=y,le=k,re=C,ue=q,se=h,te=m;return p(),l("div",F,[r("div",I,[u(t,{value:R.value,"onUpdate:value":a[0]||(a[0]=e=>R.value=e),allowClear:"",placeholder:"输入用户名搜索",onSearch:M},null,8,["value"]),u(x,{type:"primary",onClick:N},{default:s((()=>a[16]||(a[16]=[c("创建用户")]))),_:1,__:[16]})]),u(Y,{spinning:$.value},{default:s((()=>[u(X,{data:O.value,"scrollbar-always-on":!0,fit:""},{default:s((()=>[u(V,{prop:"username",label:"用户名",fixed:""}),u(V,{prop:"name",label:"IP地址"},{default:s((({row:e})=>{var a,l;return[c(g((null==(a=e.ip)?void 0:a.ipv4)||(null==(l=e.ip)?void 0:l.ipv6)),1)]})),_:1}),u(V,{prop:"email",label:"注册邮箱"}),u(V,{prop:"role",label:"角色"},{default:s((({row:e})=>[c(g("admin"===e.role?"管理员":"注册用户"),1)])),_:1}),u(V,{prop:"date",label:"状态"},{default:s((({row:e})=>[u(W,{color:"active"===e.status?"green":"red"},{default:s((()=>[c(g("active"===e.status?"正常":"封号"),1)])),_:2},1032,["color"])])),_:1}),u(V,{prop:"createdAt",sortable:"",label:"注册时间"},{default:s((({row:e})=>[c(g(w(z)(e.createdAt)),1)])),_:1}),u(V,{prop:"lastLogin",sortable:"",label:"最后登录"},{default:s((({row:e})=>[c(g(w(z)(e.lastLogin)),1)])),_:1}),u(V,{label:"操作",fixed:"right"},{default:s((({row:e})=>[u(x,{type:"link",onClick:a=>{return l=e,B.value={_id:l._id,username:l.username,email:l.email,role:l.role,status:l.status,founder:l.founder,password:""},H.value=!0,void(P.value&&P.value.resetFields());var l}},{default:s((()=>a[17]||(a[17]=[c("编辑")]))),_:2,__:[17]},1032,["onClick"]),u(x,{type:"link",danger:"",onClick:a=>(async e=>{e.founder?o.error("无法删除创始人账号"):m.confirm({title:"确认删除",content:`确定要删除用户 "${e.username}" 的账号吗？`,async onOk(){var a;try{await j.delete(`/api/admin/users/${e._id}`),o.success("该账号已删除"),M()}catch({response:l}){o.error(null==(a=null==l?void 0:l.data)?void 0:a.error)}}})})(e),disabled:e.founder},{default:s((()=>a[18]||(a[18]=[c("删除")]))),_:2,__:[18]},1032,["onClick","disabled"])])),_:1})])),_:1},8,["data"])])),_:1},8,["spinning"]),u(Z,{class:"pagination",current:A.value,"onUpdate:current":a[1]||(a[1]=e=>A.value=e),"page-size":J.value,"onUpdate:pageSize":a[2]||(a[2]=e=>J.value=e),total:L.value,"show-size-changer":"",onChange:M},null,8,["current","page-size","total"]),u(te,{open:S.value,"onUpdate:open":a[7]||(a[7]=e=>S.value=e),title:"创建用户",onOk:Q,onCancel:a[8]||(a[8]=e=>S.value=!1)},{default:s((()=>[u(se,{model:E.value,rules:G,layout:"vertical",ref_key:"createFormRef",ref:D},{default:s((()=>[u(ae,{label:"用户名",name:"username"},{default:s((()=>[u(ee,{value:E.value.username,"onUpdate:value":a[3]||(a[3]=e=>E.value.username=e),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(ae,{label:"邮箱",name:"email"},{default:s((()=>[u(ee,{value:E.value.email,"onUpdate:value":a[4]||(a[4]=e=>E.value.email=e),placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(ae,{label:"密码",name:"password"},{default:s((()=>[u(le,{value:E.value.password,"onUpdate:value":a[5]||(a[5]=e=>E.value.password=e),placeholder:"请输入密码"},null,8,["value"])])),_:1}),u(ae,{label:"权限",name:"role"},{default:s((()=>[u(ue,{value:E.value.role,"onUpdate:value":a[6]||(a[6]=e=>E.value.role=e)},{default:s((()=>[u(re,{value:"user"},{default:s((()=>a[19]||(a[19]=[c("用户")]))),_:1,__:[19]}),u(re,{value:"admin"},{default:s((()=>a[20]||(a[20]=[c("管理员")]))),_:1,__:[20]})])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"]),u(te,{open:H.value,"onUpdate:open":a[14]||(a[14]=e=>H.value=e),title:"编辑用户",onOk:T,onCancel:a[15]||(a[15]=e=>H.value=!1)},{default:s((()=>[u(se,{model:B.value,rules:K,layout:"vertical",ref_key:"editFormRef",ref:P},{default:s((()=>[u(ae,{label:"用户名",name:"username"},{default:s((()=>[u(ee,{value:B.value.username,"onUpdate:value":a[9]||(a[9]=e=>B.value.username=e),placeholder:"请输入用户名"},null,8,["value"])])),_:1}),u(ae,{label:"邮箱",name:"email"},{default:s((()=>[u(ee,{value:B.value.email,"onUpdate:value":a[10]||(a[10]=e=>B.value.email=e),placeholder:"请输入邮箱"},null,8,["value"])])),_:1}),u(ae,{label:"权限",name:"role"},{default:s((()=>[u(ue,{value:B.value.role,"onUpdate:value":a[11]||(a[11]=e=>B.value.role=e),disabled:B.value.founder},{default:s((()=>[u(re,{value:"user"},{default:s((()=>a[21]||(a[21]=[c("用户")]))),_:1,__:[21]}),u(re,{value:"admin"},{default:s((()=>a[22]||(a[22]=[c("管理员")]))),_:1,__:[22]})])),_:1},8,["value","disabled"])])),_:1}),u(ae,{label:"状态",name:"status"},{default:s((()=>[u(ue,{value:B.value.status,"onUpdate:value":a[12]||(a[12]=e=>B.value.status=e),disabled:B.value.founder},{default:s((()=>[u(re,{value:"active"},{default:s((()=>a[23]||(a[23]=[c("正常")]))),_:1,__:[23]}),u(re,{value:"disabled"},{default:s((()=>a[24]||(a[24]=[c("封号")]))),_:1,__:[24]})])),_:1},8,["value","disabled"])])),_:1}),u(ae,{label:"新密码",name:"password"},{default:s((()=>[u(le,{value:B.value.password,"onUpdate:value":a[13]||(a[13]=e=>B.value.password=e),placeholder:"留空则不修改密码"},null,8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["open"])])}}},[["__scopeId","data-v-1ed6a8f6"]]);export{O as default};
