import{_ as a,u as e,i as l}from"./index-D-heiWuO.js";import{r as s,ah as r,o,f as t,g as i,i as d,m as n,a8 as u,k as c,l as v,af as m,ai as p,aj as f,h as y,A as w,j as _,aG as b,E as h,q as g,x as P,ak as k,al as x,aA as E,y as U,z as q,$ as C,J as I,a3 as j,U as G,aB as z,an as F,aC as K}from"./vendor-Ct0GE2cv.js";const A={class:"settings"},B={class:"avatar-upload"},D={class:"social-accounts"},H={class:"accounts-grid"},L={key:0,class:"account-card"},M={class:"account-info"},S={key:0,class:"account-name"},$={key:1,class:"account-name"},J=["onClick"],O=["onClick"],R=a({__name:"Settings",setup(a){const R=e(),T=s("basic"),W=s(!1),N=s(0),Q=r({username:"",email:"",avatar:""}),V=r({oldPassword:"",newPassword:"",confirmPassword:""}),X=r({newEmail:"",code:""});o((()=>{var a,e,l;Q.username=null==(a=R.user)?void 0:a.username,Q.email=null==(e=R.user)?void 0:e.email,Q.avatar=null==(l=R.user)?void 0:l.avatar}));const Y=a=>a.toLowerCase().replace(/\s+/g,""),Z=async(a,e)=>{if(e!==V.newPassword)throw new Error("两次输入的密码不一致")},aa=a=>{if(!a.type.startsWith("image/"))return I.error("只能上传图片文件!"),!1;return!!(a.size/1024/1024<2)||(I.error("图片大小不能超过 2MB!"),!1)},ea=async({file:a})=>{var e;if(!W.value)try{const e=new FormData;e.append("image",a);const{data:s}=await l.post("/api/upload-avatar",e);Q.avatar=s.avatar,R.user.avatar=s.avatar,I.success("头像更新成功")}catch({response:s}){I.error((null==(e=null==s?void 0:s.data)?void 0:e.error)||"上传失败")}finally{W.value=!1}},la=async()=>{var a;try{W.value=!0,await l.post("/api/auth/change-password",j.stringify(V)),I.success("密码修改成功"),V.oldPassword="",V.newPassword="",V.confirmPassword=""}catch({response:e}){I.error((null==(a=null==e?void 0:e.data)?void 0:a.error)||"密码修改失败")}finally{W.value=!1}},sa=async()=>{var a,e,s;if(null==(e=null==(a=null==R?void 0:R.config)?void 0:a.smtp)?void 0:e.enabled)try{await l.post("/api/auth/user/send-code",j.stringify({email:X.newEmail,type:"email"})),I.success("验证码已发送"),N.value=60;const a=setInterval((()=>{N.value--,N.value<=0&&clearInterval(a)}),1e3)}catch({response:r}){I.error((null==(s=null==r?void 0:r.data)?void 0:s.error)||"发送验证码失败")}else I.warning("SMTP功能未开启, 请联系管理员")},ra=async()=>{var a;try{W.value=!0,await l.post("/api/auth/user/verify-code",j.stringify({email:X.newEmail,code:X.code})),I.success("邮箱修改成功"),Q.email=X.newEmail,X.newEmail="",X.code=""}catch({response:e}){I.error((null==(a=null==e?void 0:e.data)?void 0:a.error)||"邮箱修改失败")}finally{W.value=!1}};return(a,e)=>{const s=w,r=h,o=b,oa=f,ta=k,ia=p,da=m,na=x,ua=E,ca=u,va=C;return i(),t("div",A,[d(va,{title:"个人设置",bordered:!1},{default:n((()=>[d(ca,{activeKey:T.value,"onUpdate:activeKey":e[7]||(e[7]=a=>T.value=a)},{default:n((()=>{var a,u;return[d(da,{key:"basic",tab:"基本信息"},{default:n((()=>[d(ia,{model:Q,layout:"vertical"},{default:n((()=>[d(oa,{label:""},{default:n((()=>{var a;return[y("div",B,[d(s,{size:100,src:_(R).config.site.url+(null==(a=_(R).user)?void 0:a.avatar),icon:_(G)},null,8,["src","icon"]),d(o,{name:"avatar","show-upload-list":!1,"before-upload":aa,customRequest:ea},{default:n((()=>[d(r,{type:"link"},{default:n((()=>{var a;return[g(P((null==(a=_(R).user)?void 0:a.avatar)?"更换头像":"上传头像"),1)]})),_:1})])),_:1})])]})),_:1}),d(oa,{label:"用户名"},{default:n((()=>[d(ta,{value:Q.username,"onUpdate:value":e[0]||(e[0]=a=>Q.username=a),disabled:""},{prefix:n((()=>[d(_(G))])),_:1},8,["value"])])),_:1}),d(oa,{label:"邮箱"},{default:n((()=>[d(ta,{value:Q.email,"onUpdate:value":e[1]||(e[1]=a=>Q.email=a),disabled:""},{prefix:n((()=>[d(_(z))])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1}),d(da,{key:"password",tab:"修改密码"},{default:n((()=>[d(ia,{model:V,onFinish:la,layout:"vertical"},{default:n((()=>[d(oa,{name:"oldPassword",label:"当前密码",rules:[{required:!0,message:"请输入当前密码"}]},{default:n((()=>[d(na,{value:V.oldPassword,"onUpdate:value":e[2]||(e[2]=a=>V.oldPassword=a),placeholder:"请输入当前密码"},{prefix:n((()=>[d(_(F))])),_:1},8,["value"])])),_:1}),d(oa,{name:"newPassword",label:"新密码",rules:[{required:!0,message:"请输入新密码"},{min:6,message:"密码长度不能小于6位"}]},{default:n((()=>[d(na,{value:V.newPassword,"onUpdate:value":e[3]||(e[3]=a=>V.newPassword=a),placeholder:"请输入新密码"},{prefix:n((()=>[d(_(F))])),_:1},8,["value"])])),_:1}),d(oa,{name:"confirmPassword",label:"确认密码",rules:[{required:!0,message:"请确认密码"},{validator:Z}]},{default:n((()=>[d(na,{value:V.confirmPassword,"onUpdate:value":e[4]||(e[4]=a=>V.confirmPassword=a),placeholder:"请确认新密码"},{prefix:n((()=>[d(_(F))])),_:1},8,["value"])])),_:1},8,["rules"]),d(oa,null,{default:n((()=>[d(r,{type:"primary","html-type":"submit",disabled:!V.oldPassword||!V.newPassword||!V.confirmPassword,loading:W.value},{default:n((()=>e[8]||(e[8]=[g(" 修改密码 ")]))),_:1,__:[8]},8,["disabled","loading"])])),_:1})])),_:1},8,["model"])])),_:1}),d(da,{key:"email",tab:"修改邮箱"},{default:n((()=>[d(ia,{model:X,onFinish:ra,layout:"vertical"},{default:n((()=>[d(oa,{name:"newEmail",label:"新邮箱",rules:[{required:!0,message:"请输入新邮箱"},{type:"email",message:"请输入有效的邮箱地址"}]},{default:n((()=>[d(ta,{value:X.newEmail,"onUpdate:value":e[5]||(e[5]=a=>X.newEmail=a),placeholder:"请输入新邮箱"},{prefix:n((()=>[d(_(z))])),_:1},8,["value"])])),_:1}),d(oa,{name:"code",label:"验证码",rules:[{required:!0,message:"请输入验证码"}]},{default:n((()=>[d(ua,{compact:""},{default:n((()=>[d(ta,{value:X.code,"onUpdate:value":e[6]||(e[6]=a=>X.code=a),placeholder:"请输入验证码",style:{width:"calc(100% - 120px)"}},{prefix:n((()=>[d(_(K))])),_:1},8,["value"]),d(r,{style:{width:"120px"},disabled:!!N.value||!X.newEmail,onClick:sa},{default:n((()=>[g(P(N.value?`${N.value}s后重试`:"获取验证码"),1)])),_:1},8,["disabled"])])),_:1})])),_:1}),d(oa,null,{default:n((()=>[d(r,{type:"primary","html-type":"submit",disabled:!X.newEmail||!X.code,loading:W.value},{default:n((()=>e[9]||(e[9]=[g(" 修改邮箱 ")]))),_:1,__:[9]},8,["disabled","loading"])])),_:1})])),_:1},8,["model"])])),_:1}),(null==(u=null==(a=_(R).config)?void 0:a.oauth)?void 0:u.enabled)?(i(),c(da,{key:"bind",tab:"账号绑定"},{default:n((()=>[y("div",D,[e[11]||(e[11]=y("h3",{class:"section-title"},"社交账号绑定",-1)),y("div",H,[(i(),t(U,null,q(["GitHub","Google","Linux DO"],((a,s)=>{var r,o,d,n,u,c;return i(),t(U,{key:s},[(null==(d=null==(o=null==(r=_(R).config)?void 0:r.oauth)?void 0:o[Y(a)])?void 0:d.enabled)?(i(),t("div",L,[e[10]||(e[10]=y("div",{class:"account-icon"},null,-1)),y("div",M,[y("h4",null,P(a),1),(null==(c=null==(u=null==(n=_(R).user)?void 0:n.oauth)?void 0:u[Y(a)])?void 0:c.id)?(i(),t(U,{key:0},["GitHub"===a?(i(),t("p",S,P(_(R).user.oauth[Y(a)].username),1)):(i(),t("p",$,P(_(R).user.oauth[Y(a)].email),1)),y("button",{class:"unbind-btn",onClick:e=>(async a=>{var e;try{await l.post("/oauth/unbind",j.stringify({type:a,userId:R.user._id})),I.success("解绑成功"),location.reload()}catch({response:s}){I.error((null==(e=null==s?void 0:s.data)?void 0:e.error)||"解绑失败")}})(Y(a))},"解绑账号",8,J)],64)):(i(),t("button",{key:1,class:"bind-btn",onClick:e=>(async a=>{var e;const{oauth:s}=null==R?void 0:R.config;if(s.enabled)try{const{data:e}=await l.post("/oauth/bind",j.stringify({type:a,userId:R.user._id,redirectUrl:location.href}));location.href=e.authUrl}catch({response:r}){I.error((null==(e=null==r?void 0:r.data)?void 0:e.error)||"解绑失败")}else I.error("社会化登录功能未启用")})(Y(a))},"绑定账号",8,O))])])):v("",!0)],64)})),64))])])])),_:1})):v("",!0)]})),_:1},8,["activeKey"])])),_:1})])}}},[["__scopeId","data-v-489e0b9c"]]);export{R as default};
